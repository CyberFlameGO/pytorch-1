# Detectron2

Uses [D2Go](https://github.com/facebookresearch/d2go), on top of PyTorch 1.8.0, CUDA 10.2 and Detectron2.

Additional code is located in:

```commandline
/opt/d2go_ext
```

## Version

git repository hashes of libraries:

* [Detectron2](https://github.com/facebookresearch/d2go): 

  * `34acc94d862b8c31f382bee5013737184f444b74`
  * 2021-03-18
  
* [mobile-vision](https://github.com/facebookresearch/mobile-vision):

  * `af4dffe4662f13210c8fc2581a6d4e4c24b7e5c8`
  * 2021-02-25
  
* [d2go](https://github.com/facebookresearch/d2go):

  * `ec2e8ffffc8b59f4fabf7b1f3f31861eb7a4af70`
  * 2021-03-19

## Docker

### Quick start

* Log into registry using *public* credentials:

  ```commandline
  docker login -u public -p public public.aml-repo.cms.waikato.ac.nz:443 
  ```

* Pull and run image (adjust volume mappings `-v`):

  ```commandline
  docker run --runtime=nvidia --shm-size 8G \
    -v /local/dir:/container/dir \
    -it public.aml-repo.cms.waikato.ac.nz:443/pytorch/d2go:2021-03-19
  ```

  **NB:** For docker versions 19.03 (`docker version`) and newer, use `--gpus=all` instead of `--runtime=nvidia`.

* If need be, remove all containers and images from your system:

  ```commandline
  docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q) && docker system prune -a
  ```

### Build local image

* Build the image from Docker file (from within /path_to/d2go/0.3)

  ```commandline
  sudo docker build -t d2go .
  ```
  
* Run the container

  ```commandline
  sudo docker run --runtime=nvidia --shm-size 8G -v /local/dir:/container/dir -it d2go
  ```
  `/local/dir:/container/dir` maps a local disk directory into a directory inside the container

## Pre-built images

* Build

  ```commandline
  docker build -t pytorch/d2go:2021-03-19 .
  ```
  
* Tag

  ```commandline
  docker tag \
    d2go:2021-03-19 \
    public-push.aml-repo.cms.waikato.ac.nz:443/pytorch/d2go:2021-03-19
  ```
  
* Push

  ```commandline
  docker push public-push.aml-repo.cms.waikato.ac.nz:443/pytorch/d2go:2021-03-19
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```commandline
  docker login public-push.aml-repo.cms.waikato.ac.nz:443
  ```
  
* Pull

  If image is available in aml-repo and you just want to use it, you can pull using following command and then [run](#run).

  ```commandline
  docker pull public.aml-repo.cms.waikato.ac.nz:443/pytorch/d2go:2021-03-19
  ```
  If error "no basic auth credentials" occurs, then run (enter username/password when prompted):
  
  ```commandline
  docker login public.aml-repo.cms.waikato.ac.nz:443
  ```
  Then tag by running:
  
  ```commandline
  docker tag \
    public.aml-repo.cms.waikato.ac.nz:443/pytorch/d2go:2021-03-19 \
    pytorch/d2go:2021-03-19
  ```
  
* <a name="run">Run</a>

  ```commandline
  docker run --runtime=nvidia --shm-size 8G \
    -v /local/dir:/container/dir -it pytorch/d2go:2021-03-19
  ```
  `/local/dir:/container/dir` maps a local disk directory into a directory inside the container


## Permissions

When running the docker container as regular use, you will want to set the correct
user and group on the files generated by the container (aka the user:group launching
the container):

```commandline
docker run -u $(id -u):$(id -g) -e USER=$USER ...
```

## Caching

Detectron2 will download pretrained models and cache them locally. To avoid having
to download them constantly, you can the cache directory to the host machine:

* when running the container as `root`

  ```commandline
  -v /some/where/cache:/root/.torch \
  ```

* when running the container as current user

  ```commandline
  -v /some/where/cache:/.torch \
  ```


## Scripts

The following additional scripts are available:

* `d2go_train_coco` - for building a model using a COCO-based train/test set (calls /opt/d2go_ext/d2go_train_coco.py)
* ...
